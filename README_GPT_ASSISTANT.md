# GPT補助機能 - 日時抽出精度向上

このドキュメントでは、LINEカレンダーBotの日時抽出精度を向上させるためのGPT補助機能について説明します。

## 概要

GPT補助機能は、既存のルールベース抽出で対応できない複雑な日時表現を、OpenAI GPT APIを使用して抽出する機能です。

### ハイブリッド方式

1. **まずルールベース抽出を試行**
   - 既存の正規表現やパターンマッチングで日時を抽出
   - 高速で確実な抽出が可能

2. **ルールベースで抽出できない場合のみGPT補助を使用**
   - 複雑な自然言語表現をGPTで解析
   - 確信度が閾値以上の場合のみ結果を使用

## 設定方法

### 1. 環境変数の設定

```bash
# OpenAI APIキー（必須）
export OPENAI_API_KEY="your-openai-api-key-here"

# オプション設定
export GPT_ASSISTANT_ENABLED="true"           # 有効/無効（デフォルト: true）
export OPENAI_MODEL="gpt-4o-mini"            # 使用モデル（デフォルト: gpt-4o-mini）
export GPT_CONFIDENCE_THRESHOLD="0.7"        # 確信度閾値（デフォルト: 0.7）
export GPT_API_TIMEOUT="10"                  # APIタイムアウト（秒）（デフォルト: 10）
export GPT_MAX_TOKENS="500"                  # 最大トークン数（デフォルト: 500）
export GPT_TEMPERATURE="0.1"                 # 温度設定（デフォルト: 0.1）
export GPT_DEBUG_MODE="false"                # デバッグモード（デフォルト: false）
```

### 2. 依存関係のインストール

```bash
pip install openai==1.12.0
```

## 使用方法

### 基本的な使用

```python
from utils.message_parser import extract_datetime_from_message

# メッセージから日時を抽出（ハイブリッド方式）
result = extract_datetime_from_message("来週の水曜日の午後3時から会議")

print(f"抽出方法: {result.get('extraction_method')}")
print(f"開始時刻: {result.get('start_time')}")
print(f"終了時刻: {result.get('end_time')}")
print(f"GPT確信度: {result.get('gpt_confidence')}")
```

### GPT補助機能の状態確認

```python
from utils.gpt_assistant import gpt_assistant

# 状態を確認
status = gpt_assistant.get_status()
print(status)
```

## 対応できる日時表現

### ルールベースで対応（高速）

- `6/23 14:00` - 月日と時刻
- `6/23と6/27` - 複数日指定
- `今日の予定` - 相対日付
- `今週` - 週単位
- `6月23日14:00-16:00` - 時間範囲

### GPT補助で対応（高精度）

- `来週の水曜日の午後3時から会議`
- `3日後の夕方6時頃に打ち合わせ`
- `今度の土曜日の朝9時から12時まで`
- `来月の第1金曜日の夜7時から`
- `明日の朝8時半から10時までミーティング`
- `今週末の土曜日と日曜日の両方でイベント`

## テスト

### テストスクリプトの実行

```bash
python test_gpt_hybrid.py
```

### テスト内容

1. **ハイブリッド方式テスト**
   - ルールベースで抽出できるケース
   - GPT補助が必要なケース
   - 抽出できないケース

2. **GPT補助機能単体テスト**
   - 複雑な日時表現の抽出テスト

## 設定の詳細

### 確信度閾値（GPT_CONFIDENCE_THRESHOLD）

- **0.0-1.0**の範囲で設定
- 高いほど厳密（デフォルト: 0.7）
- 低すぎると誤抽出の可能性が増加
- 高すぎるとGPT補助が使われにくくなる

### モデル選択（OPENAI_MODEL）

- `gpt-4o-mini` - 高速、低コスト（推奨）
- `gpt-4o` - 高精度、高コスト
- `gpt-3.5-turbo` - バランス型

### 温度設定（GPT_TEMPERATURE）

- **0.0-1.0**の範囲で設定
- 低いほど一貫性が高い（デフォルト: 0.1）
- 日時抽出では低めの設定を推奨

## コスト管理

### APIコストの最適化

1. **確信度閾値を適切に設定**
   - 不要なAPI呼び出しを削減

2. **モデルの選択**
   - `gpt-4o-mini`を使用してコストを削減

3. **タイムアウト設定**
   - 適切なタイムアウトで応答時間を制御

### 使用量監視

```python
# ログでGPT補助の使用状況を確認
# ログレベル: INFO以上でGPT補助の使用が記録されます
```

## トラブルシューティング

### よくある問題

1. **GPT補助が動作しない**
   - APIキーが正しく設定されているか確認
   - 環境変数`GPT_ASSISTANT_ENABLED`が`true`になっているか確認

2. **抽出精度が低い**
   - 確信度閾値を調整
   - プロンプトの改善を検討

3. **API呼び出しが失敗する**
   - ネットワーク接続を確認
   - APIキーの有効性を確認
   - タイムアウト設定を調整

### デバッグモード

```bash
export GPT_DEBUG_MODE="true"
```

デバッグモードを有効にすると、詳細なログが出力されます。

## セキュリティとプライバシー

### データ送信

- メッセージ内容がOpenAI APIに送信されます
- 機密情報を含むメッセージには注意してください

### APIキーの管理

- 環境変数でAPIキーを管理
- ソースコードに直接記述しない
- 定期的にAPIキーをローテーション

## 今後の改善予定

- [ ] キャッシュ機能の追加
- [ ] より詳細な確信度評価
- [ ] 複数のLLMプロバイダー対応
- [ ] オフラインでの軽量モデル対応

## サポート

問題や質問がある場合は、以下の方法でサポートを受けられます：

1. ログファイルの確認
2. デバッグモードでの詳細ログ出力
3. テストスクリプトでの動作確認 